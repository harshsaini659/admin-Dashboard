<%- include('../partials/header', { title: title }) %>
<%- include('../partials/sidebar', { currentPage: 'categories' }) %>
        <main class="main-wrap">
            <%- include('../partials/navbar') %>
            <section class="content-main">
                <div class="content-header">
                    <div>
                        <h2 class="content-title card-title"><%= title %></h2>
                        <p>Manage your product categories</p>
                    </div>
                    <div>
                        <a href="/admin/user/categories/create" class="btn btn-primary">
                            <i class="material-icons md-add"></i> Add Category
                        </a>
                    </div>
                </div>
                
                <!-- Success Message -->
                <% if (typeof success !== 'undefined' && success) { %>
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <%= success %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>
                
                <!-- Error Message -->
                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <% if (categories && categories.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Category Hierarchy</th>
                                            <th scope="col">Parent</th>
                                            <th scope="col">Status</th>
                                            <th scope="col">Created</th>
                                            <th scope="col">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% categories.forEach((category, index) => { %>
                                            <tr>
                                                <th scope="row"><%= index + 1 %></th>
                                                <td>
                                                    <strong><%= category.hierarchyPath %></strong>
                                                    <% if (category.children && category.children.length > 0) { %>
                                                        <span class="badge badge-soft-info ms-2"><%= category.children.length %> subcategory(ies)</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (category.parent && category.parent.name) { %>
                                                        <span class="text-primary"><%= category.parent.name %></span>
                                                    <% } else { %>
                                                        <span class="text-muted">Root Category</span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (category.status === 'active') { %>
                                                        <span class="badge badge-pill badge-soft-success">Active</span>
                                                    <% } else { %>
                                                        <span class="badge badge-pill badge-soft-secondary">Inactive</span>
                                                    <% } %>
                                                </td>
                                                <td><%= new Date(category.createdAt).toLocaleDateString() %></td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <a href="/admin/user/categories/edit/<%= category._id %>" class="btn btn-light btn-sm" title="Edit Category">
                                                            <i class="material-icons md-edit"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-light btn-sm text-danger" onclick="deleteCategory('<%= category._id %>', '<%= category.name %>')" title="Delete Category">
                                                            <i class="material-icons md-delete"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="material-icons md-category" style="font-size: 4rem; color: #ddd;"></i>
                                <h4 class="mt-3 text-muted">No Categories Found</h4>
                                <p class="text-muted">Start by creating your first category.</p>
                                <a href="/admin/user/categories/create" class="btn btn-primary">
                                    <i class="material-icons md-add"></i> Add Category
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            </section>
            <%- include('../partials/footer') %>
        </main>
        
        <script>
            function deleteCategory(id, name) {
                if (confirm(`Are you sure you want to delete the category "${name}"?`)) {
                    // Create a form to submit DELETE request
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin/user/categories/delete/${id}`;
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        </script>
        
        <script>
            // Clear URL parameters after showing success/error messages to prevent re-showing on refresh
            if (window.location.search.includes('success=') || window.location.search.includes('error=')) {
                // Use setTimeout to allow the alert to be visible first
                setTimeout(() => {
                    const url = new URL(window.location);
                    url.searchParams.delete('success');
                    url.searchParams.delete('error');
                    window.history.replaceState({}, document.title, url.pathname + url.search);
                }, 100);
            }
            
            // Auto-dismiss alerts after 5 seconds
            document.addEventListener('DOMContentLoaded', function() {
                const alerts = document.querySelectorAll('.alert.alert-dismissible');
                
                alerts.forEach(function(alert) {
                    // Auto-dismiss after 5 seconds
                    setTimeout(function() {
                        // Use Bootstrap's alert method to close
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }, 5000);
                });
            });
        </script>