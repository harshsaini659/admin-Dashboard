<%- include('../partials/header') %>
<%- include('../partials/sidebar') %>
        <main class="main-wrap">
<%- include('../partials/navbar') %>
            <section class="content-main">
                <div class="content-header">
                    <div>
                        <h2 class="content-title card-title"><%= title %></h2>
                        <p>Add a new product to your inventory</p>
                    </div>
                    <div>
                        <a href="/admin/user/products" class="btn btn-light">
                            <i class="material-icons md-arrow_back"></i> Back to Products
                        </a>
                    </div>
                </div>
                
                <!-- Error Message -->
                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>
                
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h4>Product Information</h4>
                            </div>
                            <div class="card-body">
                                <form id="productForm">
                                    <div class="mb-4">
                                        <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="productName" name="name" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="productDescription" class="form-label">Description <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="productDescription" name="description" rows="4" required></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="productCategory" class="form-label">Category <span class="text-danger">*</span></label>
                                                <select class="form-select" id="productCategory" name="category" required>
                                                    <option value="">Select Category</option>
                                                    <% if (typeof categories !== 'undefined' && categories.length > 0) { %>
                                                        <% categories.forEach(category => { %>
                                                            <option value="<%= category._id %>"><%= category.name %></option>
                                                        <% }) %>
                                                    <% } %>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="variantStatus" class="form-label">Status</label>
                                            <select class="form-select" id="variantStatus" name="status">
                                                <option value="active" selected>Active</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                            <div class="form-text">Set the variant attribute availability status</div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="productVariant" class="form-label">Variant <span class="text-danger">*</span></label>
                                                <select class="form-select" id="productVariant" name="variant" required>
                                                    <option value="">Select Variant</option>
                                                    <% if (typeof variants !== 'undefined' && variants.length > 0) { %>
                                                        <% variants.forEach(variant => { %>
                                                            <option value="<%= variant._id %>"><%= variant.name %></option>
                                                        <% }) %>
                                                    <% } %>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="productVariantAtt" class="form-label">Variant Attribute <span class="text-danger">*</span></label>
                                                <select class="form-select" id="productVariantAtt" name="variantAttribute" required>
                                                    <option value="">Select Variant Attribute</option>
                                                    <% if (typeof variantAttributes !== 'undefined' && variantAttributes.length > 0) { %>
                                                        <% variantAttributes.forEach(variantAttribute => { %>
                                                            <option value="<%= variantAttribute._id %>"><%= variantAttribute.name %></option>
                                                        <% }) %>
                                                    <% } %>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons at Bottom -->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <a href="/admin/user/products" class="btn btn-light">
                                        <i class="material-icons md-cancel"></i> Cancel
                                    </a>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                                            <i class="material-icons md-drafts"></i> Save as Draft
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="saveProduct()">
                                            <i class="material-icons md-save"></i> Save Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        
        <script>
            // Collect form data
            function collectFormData() {
                const form = document.getElementById('productForm');
                const formData = new FormData(form);
                
                const data = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    category: formData.get('category'),
                    status: formData.get('status'),
                    variant: formData.get('variant'),
                    variantAttribute: formData.get('variantAttribute')
                };
                
                return data;
            }
            
            // Save product
            function saveProduct() {
                const formData = collectFormData();
                formData.status = formData.status || 'active'; // Ensure status is set
                submitProduct(formData);
            }
            
            // Save as draft
            function saveDraft() {
                const formData = collectFormData();
                formData.status = 'inactive'; // Draft is always inactive
                submitProduct(formData);
            }
            
            // Submit product
            function submitProduct(data) {
                fetch('/admin/user/products/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.message && result.message.includes('successfully')) {
                        window.location.href = '/admin/user/products?success=' + encodeURIComponent(result.message);
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving product: ' + error.message);
                });
            }
            
            // Event listeners
            document.addEventListener('DOMContentLoaded', function() {
                // Auto-dismiss alerts
                const alerts = document.querySelectorAll('.alert.alert-dismissible');
                alerts.forEach(function(alert) {
                    setTimeout(function() {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }, 5000);
                });
            });
        </script>
<%- include('../partials/footer') %>
                const alerts = document.querySelectorAll('.alert.alert-dismissible');
                alerts.forEach(function(alert) {
                    setTimeout(function() {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }, 5000);
                });
            });
        </script>
    </body>
</html>
