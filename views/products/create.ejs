<%- include('../partials/header') %>
<%- include('../partials/sidebar') %>
        <main class="main-wrap">
<%- include('../partials/navbar') %>
            <section class="content-main">
                <div class="content-header">
                    <div>
                        <h2 class="content-title card-title"><%= title %></h2>
                        <!-- <p>Add a new product to your inventory</p> -->
                    </div>
                    <div>
                        <a href="/admin/user/products" class="btn btn-light">
                            <i class="material-icons md-arrow_back"></i> Back to Products
                        </a>
                    </div>
                </div>
                
                <!-- Error Message -->
                <% if (typeof error !== 'undefined' && error) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <%= error %>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                <% } %>
                
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <!-- <div class="card-header">
                                <h4>Product Information</h4>
                            </div> -->

                            
                            <div class="card-body">
                                <form id="productForm">
                                    <div class="mb-4">
                                        <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" placeholder="Enter product name" id="productName" name="name" required>
                                    </div>
                                    
                                    <div class="row">
                                        <!-- Parent Category Tree Dropdown -->
                                        <div class="col-12 mb-3">
                                            <label for="categoryParent" class="form-label">Category <span class="text-danger">*</span></label>
                                            <input type="text" id="categoryParentTree" class="form-control" placeholder="Select a category" readonly>
                                            <input type="hidden" id="categoryParent" name="category" value="">
                                            <!-- <div class="form-text">Select a product category</div> -->
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-4">
                                                <label for="variantStatus" class="form-label">Status</label>
                                                <select class="form-select" id="variantStatus" name="status">
                                                    <option value="active" selected>Active</option>
                                                    <option value="inactive">Inactive</option>
                                                </select>
                                                <!-- <div class="form-text">Set the product availability status</div> -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Variants Section -->
                                    <div class="mb-4">
                                        <label class="form-label">Product Variants</label>
                                        <!-- <div class="form-text mb-3">Add variants to set different pricing for different attributes (Color, Size, etc.)</div> -->
                                        
                                        <!-- Added Variants Display -->
                                        <div id="addedVariantsSection" class="mb-3" style="display: none;">
                                            <div class="card">
                                                <div class="card-header py-2">
                                                    <h6 class="mb-0">Added Variants</h6>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-sm mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Variant</th>
                                                                    <th>Attribute</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="addedVariantsList">
                                                                <!-- Added variants will appear here -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Add Variant Button -->
                                        <div id="addVariantButton">
                                            <button type="button" class="btn btn-outline-primary" onclick="showVariantForm()">
                                                <i class="material-icons md-add"></i> Add Variant
                                            </button>
                                        </div>
                                        
                                        <!-- Variant Sub-form (Hidden by default) -->
                                        <div id="variantForm" class="card mt-3" style="display: none;">
                                            <div class="card-header py-2">
                                                <h6 class="mb-0">Add New Variant</h6>
                                            </div>
                                            <div class="card-body">
                                                <!-- First Row: Variant Selection -->
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label for="formVariant" class="form-label">Variant <span class="text-danger">*</span></label>
                                                        <select class="form-select" id="formVariant">
                                                            <option value="">Select Variant</option>
                                                            <% if (typeof variants !== 'undefined' && variants.length > 0) { %>
                                                                <% variants.forEach(variant => { %>
                                                                    <option value="<%= variant._id %>"><%= variant.name %></option>
                                                                <% }) %>
                                                            <% } %>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="formVariantAtt" class="form-label">Attribute <span class="text-danger">*</span></label>
                                                        <select class="form-select" id="formVariantAtt" disabled>
                                                            <option value="">Select Variant First</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <!-- Third Row: Stock and Actions -->
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">&nbsp;</label>
                                                        <div class="d-flex gap-2">
                                                            <button type="button" class="btn btn-success" onclick="saveVariant()">
                                                                <i class="material-icons md-check"></i> Save Variant
                                                            </button>
                                                            <button type="button" class="btn btn-secondary" onclick="cancelVariantForm()">
                                                                <i class="material-icons md-close"></i> Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Default Product Pricing Fields (shown when no variants) -->
                                    <div id="defaultPricingFields" class="mb-4" onchange="initializeDefaultPricing()">
                                        <label class="form-label">Product Pricing & Stock</label>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="productPrice" class="form-label">MRP <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control" id="productPrice" name="price" placeholder="0.00" step="0.01" min="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="productDiscount" class="form-label">Discount (%)</label>
                                                    <input type="number" class="form-control" id="productDiscount" name="discount" placeholder="0" step="0.01" min="0" max="100" value="0">
                                                    <div class="invalid-feedback" id="discountError" style="display: none;">
                                                        Discount cannot be more than 100%
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="productFinalPrice" class="form-label">Final Price</label>
                                                    <input type="number" class="form-control" id="productFinalPrice" name="finalPrice" placeholder="0.00" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="productStock" class="form-label">Stock <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control" id="productStock" name="stock" placeholder="0" min="0" value="0">
                                                </div>
                                            </div>
                                        </div>
                                        <!-- <div class="form-text">Set the default pricing and stock for this product (will be hidden when variants are added)</div> -->
                                    </div>
                                    
                                    <!-- Short Description Field -->
                                    <div class="mb-4">
                                        <label for="productShortDescription" class="form-label">Short Description <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="productShortDescription" name="shortDescription" rows="2" required placeholder="Brief summary of the product"></textarea>
                                    </div>
                                    
                                    <!-- Rich Text Description Field -->
                                    <div class="mb-4">
                                        <label for="productDescription" class="form-label">Description <span class="text-danger">*</span></label>
                                        <div id="descriptionEditor" style="height: 200px;"></div>
                                        <textarea class="form-control d-none" id="productDescription" name="description" required></textarea>
                                    </div>
                                    
                                    <!-- Image Upload Field -->
                                    <div class="mb-4">
                                        <label for="productImage" class="form-label">Product Image</label>
                                        <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
                                        <div class="form-text">Upload product image (JPEG, PNG, WEBP - Max 5MB)</div>
                                        
                                        <!-- Image Preview Container -->
                                        <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                                            <div class="card" style="max-width: 300px;">
                                                <div class="card-body p-2">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <small class="text-muted">Image Preview</small>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeImagePreview()">
                                                            <i class="material-icons md-close"></i>
                                                        </button>
                                                    </div>
                                                    <img id="imagePreview" src="" alt="Preview" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons at Bottom -->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <a href="/admin/user/products" class="btn btn-light">
                                        <i class="material-icons md-cancel"></i> Cancel
                                    </a>
                                    <div class="d-flex gap-2">
                                        <!-- <button type="button" class="btn btn-secondary" onclick="saveDraft()">
                                            <i class="material-icons md-drafts"></i> Save as Draft
                                        </button> -->
                                        <button type="button" class="btn btn-primary" onclick="saveProduct()">
                                            <i class="material-icons md-save"></i> Save Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        
        <!-- Quill Rich Text Editor -->
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
        
        <script>
            let quill;
            
            // Initialize Quill editor
            document.addEventListener('DOMContentLoaded', function() {
                quill = new Quill('#descriptionEditor', {
                    theme: 'snow',
                    placeholder: 'Enter detailed product description...',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            [{ 'font': [] }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            [{ 'align': [] }],
                            ['blockquote', 'code-block'],
                            ['link', 'image'],
                            ['clean']
                        ]
                    }
                });
                
                // Initialize image upload preview
                initializeImagePreview();
                
                // Initialize variant filtering
                initializeVariantFiltering();
                
                // Initialize default pricing calculation
                <!-- initializeDefaultPricing(); -->
                
                // Auto-dismiss alerts
                const alerts = document.querySelectorAll('.alert.alert-dismissible');
                alerts.forEach(function(alert) {
                    setTimeout(function() {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }, 5000);
                });
            });
            
            // Collect form data
            function collectFormData() {
                const form = document.getElementById('productForm');
                const formData = new FormData(form);   //FormData ki help se maine formData main sari fields ki values leli.

                // Get rich text content from Quill editor
                const description = quill.getContents();
                const descriptionHTML = quill.root.innerHTML;
                
                // Get image file
                const imageFile = document.getElementById('productImage').files[0];
                
                const data = {
                    name: formData.get('name'),
                    category: formData.get('category'),
                    status: formData.get('status'),
                    variants: addedVariants, // Use the addedVariants array
                    price: formData.get('price'),
                    discount: formData.get('discount'),
                    finalPrice: formData.get('finalPrice'),
                    stock: formData.get('stock'),
                    shortDescription: formData.get('shortDescription'),
                    description: descriptionHTML,
                    hasImage: !!imageFile
                };
                
                // If no variants are used, include default pricing
                if (addedVariants.length === 0) {
                    data.price = formData.get('price');
                    data.discount = formData.get('discount');
                    data.finalPrice = formData.get('finalPrice');
                    data.stock = formData.get('stock');
                }
                
                // If there's an image, we'll need to handle file upload separately
                if (imageFile) {
                    data.imageFile = imageFile;
                }
                
                return data;
            }
            
            // Save product
            function saveProduct() {
                const formData = collectFormData();
                console.log("Product Form Data from saveProduct() function: ",formData);
                formData.status = formData.status || 'active'; // Ensure status is set
                console.log("Data from saveProduct :",formData)
                submitProduct(formData);
            }
            
            // Submit product
            function submitProduct(data) {
                // Validate required fields
                if (!data.category || data.category === '' || data.category === 'null') {
                    alert('Please select a category for the product');
                    return;
                }
                
                if (!data.name || !data.name.trim()) {
                    alert('Please enter a product name');
                    return;
                }
                
                if (!data.shortDescription || !data.shortDescription.trim()) {
                    alert('Please enter a short description');
                    return;
                }
                
                if (!data.description || data.description.trim() === '<p><br></p>' || data.description.trim() === '') {
                    alert('Please enter a detailed description');
                    return;
                }
                
                // Create FormData for file upload
                const formData = new FormData(); // or yaha main FormData function ki help se main empty formData create kiya.
                
                // Add regular form fields
                formData.append('name', data.name);
                formData.append('category', data.category);
                formData.append('status', data.status);
                formData.append('shortDescription', data.shortDescription);
                formData.append('description', data.description);
                
                // Send the exact array you have on the client:
                formData.append('variants', JSON.stringify(data.variants || []));

                formData.append('price', data.price);
                formData.append('discount', data.discount || '0');
                formData.append('finalPrice', data.finalPrice);
                formData.append('stock', data.stock || '0'); // Add stock if available
                
                // Add image file if present
                if (data.imageFile) formData.append('image', data.imageFile);
                
               const res =  fetch('/admin/user/products/create', {
                    method: 'POST',
                    body: formData // Don't set Content-Type header, let browser set it with boundary
                })
                .then(response => response.json()) //ye chalta hai or backend ka JSON response yaha milta hai or JS Object main convert ho jata hai.)
                .then(result => {
                    if (result.message && result.message.includes('successfully')) {
                        window.location.href = '/admin/user/products?success=' + encodeURIComponent(result.message);
                    } else {
                        throw new Error(result.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving product: ' + error.message);
                });
            }
            
            // Initialize image preview functionality
            function initializeImagePreview() {
                const imageInput = document.getElementById('productImage');
                const previewContainer = document.getElementById('imagePreviewContainer');
                const previewImage = document.getElementById('imagePreview');
                
                imageInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    
                    if (file) {
                        // Validate file type
                        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                        if (!allowedTypes.includes(file.type)) {
                            alert('Please select a valid image file (JPEG, PNG, or WEBP)');
                            this.value = '';
                            previewContainer.style.display = 'none';
                            return;
                        }
                        
                        // Validate file size (5MB max)
                        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
                        if (file.size > maxSize) {
                            alert('File size must be less than 5MB');
                            this.value = '';
                            previewContainer.style.display = 'none';
                            return;
                        }
                        
                        // Create FileReader to read the file
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImage.src = e.target.result;
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        previewContainer.style.display = 'none';
                    }
                });
            }
            
            // Remove image preview
            function removeImagePreview() {
                const imageInput = document.getElementById('productImage');
                const previewContainer = document.getElementById('imagePreviewContainer');
                
                imageInput.value = '';
                previewContainer.style.display = 'none';
            }
            
            // Initialize default pricing calculation
            function initializeDefaultPricing() {
                console.log('Initializing default pricing calculation...');
                
                const productPrice = document.getElementById('productPrice');
                const productDiscount = document.getElementById('productDiscount');
                const productFinalPrice = document.getElementById('productFinalPrice');
                const discountError = document.getElementById('discountError');

                //console.log("progyguy", productPrice, productDiscount, productFinalPrice);

                // Check if elements exist
                if (!productPrice || !productDiscount || !productFinalPrice) {
                    console.error('Default pricing elements not found:', {
                        productPrice: !!productPrice,
                        productDiscount: !!productDiscount,
                        productFinalPrice: !!productFinalPrice
                    });
                    return;
                }
                
                window.calculateDefaultFinalPrice = function() {
                    const price = parseFloat(productPrice.value) || 0;
                    const discount = parseFloat(productDiscount.value) || 0;
                    // Validate discount
                    if (discount > 100) {
                        productDiscount.classList.add('is-invalid');
                        if (discountError) {
                            discountError.style.display = 'block';
                        }
                        productFinalPrice.value = '';
                        return;
                    } else {
                        productDiscount.classList.remove('is-invalid');
                        if (discountError) {
                            discountError.style.display = 'none';
                        }
                    }
                    // Calculate final price
                    let finalPrice;
                    if (discount === 0 || isNaN(discount)) {
                        finalPrice = price; // Final Price = MRP when no discount
                    } else {
                        finalPrice = price - (price * discount / 100);
                    }
                    productFinalPrice.value = finalPrice.toFixed(2);
                };
                // Add event listeners
                productPrice.addEventListener('input', window.calculateDefaultFinalPrice);
                productDiscount.addEventListener('input', window.calculateDefaultFinalPrice);
                // Calculate initial value
                window.calculateDefaultFinalPrice();
            }
            
            // Array to store added variants
            let addedVariants = [];
            
            // Show variant form
            function showVariantForm() {
                document.getElementById('variantForm').style.display = 'block';
                document.getElementById('addVariantButton').style.display = 'none';
                
                // Hide default pricing fields immediately when variant form is shown
                //const defaultPricingFields = document.getElementById('defaultPricingFields');
                //defaultPricingFields.style.display = 'none';
                
                // Initialize form functionality
                initializeVariantForm();
            }
            
            // Initialize variant form functionality
            function initializeVariantForm() {
                const variantAttributesData = <%- JSON.stringify(variantAttributes) %>;
                const formVariant = document.getElementById('formVariant');
                const formVariantAtt = document.getElementById('formVariantAtt');
                //const formPrice = document.getElementById('formPrice');
                //const formDiscount = document.getElementById('formDiscount');
                //const formFinalPrice = document.getElementById('formFinalPrice');
                
                // Add event listener for variant selection
                formVariant.addEventListener('change', function() {
                    updateFormVariantAttributes(this.value, variantAttributesData);
                });
                
                // Add event listeners for price calculation
                //formPrice.addEventListener('input', calculateFormFinalPrice);
                //formDiscount.addEventListener('input', calculateFormFinalPrice);
            }
            
            // Update variant attributes in form
            function updateFormVariantAttributes(selectedVariantId, variantAttributesData) {
                const formVariantAtt = document.getElementById('formVariantAtt');
                
                formVariantAtt.innerHTML = '<option value="">Select Variant First</option>';
                formVariantAtt.disabled = true;
                
                if (selectedVariantId) {
                    const filteredAttributes = variantAttributesData.filter(attr => 
                        attr.variantName && attr.variantName._id === selectedVariantId
                    );
                    
                    if (filteredAttributes.length > 0) {
                        formVariantAtt.innerHTML = '<option value="">Select Variant Attribute</option>';
                        filteredAttributes.forEach(attr => {
                            const option = document.createElement('option');
                            option.value = attr._id;
                            option.textContent = attr.name;
                            formVariantAtt.appendChild(option);
                        });
                        formVariantAtt.disabled = false;
                    }
                }
            }
            
            // Calculate final price in form
            function calculateFormFinalPrice() {
                const formPrice = document.getElementById('formPrice');
                const formDiscount = document.getElementById('formDiscount');
                const formFinalPrice = document.getElementById('formFinalPrice');
                
                const price = parseFloat(formPrice.value) || 0;
                const discount = parseFloat(formDiscount.value) || 0;
                const finalPrice = price - (price * discount / 100);
                
                formFinalPrice.value = finalPrice.toFixed(2);
            }
            
            // Save variant from form
            function saveVariant() {
                const formVariant = document.getElementById('formVariant');
                const formVariantAtt = document.getElementById('formVariantAtt');
                
                // Validation
                if (!formVariant.value) {
                    alert('Please select a variant');
                    return;
                }
                
                if (!formVariantAtt.value) {
                    alert('Please select a variant attribute');
                    return;
                }
                
                // Check for duplicate combination
                const existingVariant = addedVariants.find(v => 
                    v.variantId === formVariant.value && v.variantAttributeId === formVariantAtt.value
                );
                
                if (existingVariant) {
                    alert('This variant combination already exists');
                    return;
                }
                
                // Create variant object
                const variantData = {
                    variantId: formVariant.value,
                    variantName: formVariant.options[formVariant.selectedIndex].text,
                    variantAttributeId: formVariantAtt.value,
                    variantAttributeName: formVariantAtt.options[formVariantAtt.selectedIndex].text,
                };
                
                // Add to array
                addedVariants.push(variantData);
                
                // Refresh display
                displayAddedVariants();
                
                // Toggle pricing fields visibility
                //togglePricingFields();
                
                // Hide form and show button
                cancelVariantForm();
            }
            
            // Cancel variant form
            function cancelVariantForm() {
                // Hide form
                document.getElementById('variantForm').style.display = 'none';
                
                // Show add button
                document.getElementById('addVariantButton').style.display = 'block';
                
                // Show default pricing fields if no variants exist
                //const defaultPricingFields = document.getElementById('defaultPricingFields');
                //if (addedVariants.length === 0) {
                //    defaultPricingFields.style.display = 'block';
                //}
                
                // Clear form
                clearVariantForm();
            }
            
            // Clear variant form
            function clearVariantForm() {
                document.getElementById('formVariant').value = '';
                document.getElementById('formVariantAtt').value = '';
                document.getElementById('formVariantAtt').disabled = true;
                document.getElementById('formVariantAtt').innerHTML = '<option value="">Select Variant First</option>';
                //document.getElementById('formPrice').value = '';
                //document.getElementById('formDiscount').value = '0';
                //document.getElementById('formFinalPrice').value = '';
                //document.getElementById('formStock').value = '0';
            }
            
            // Display added variants in table
            function displayAddedVariants() {
                const addedVariantsList = document.getElementById('addedVariantsList');
                const addedVariantsSection = document.getElementById('addedVariantsSection');
                
                if (addedVariants.length === 0) {
                    addedVariantsSection.style.display = 'none';
                    return;
                }
                
                addedVariantsSection.style.display = 'block';
                
                let tableHTML = '';
                addedVariants.forEach((variant, index) => {
                    tableHTML += `
                        <tr>
                            <td>${variant.variantName}</td>
                            <td>${variant.variantAttributeName}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariant(${index})" title="Remove">
                                    <i class="material-icons md-delete" style="font-size: 14px;"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                addedVariantsList.innerHTML = tableHTML;
            }
            
            // Remove variant
            function removeVariant(index) {
                if (confirm('Are you sure you want to remove this variant?')) {
                    addedVariants.splice(index, 1);
                    displayAddedVariants();
                    
                    // Toggle pricing fields visibility
                   // togglePricingFields();
                }
            }
            
            // Initialize variant filtering functionality
            function initializeVariantFiltering() {
                // Get variant attributes data from backend
                const variantAttributesData = <%- JSON.stringify(variantAttributes) %>;
                
                const variantSelect = document.getElementById('productVariant');
                const variantAttributeSelect = document.getElementById('productVariantAtt');
                
                // Add event listener for variant selection change
                variantSelect.addEventListener('change', function() {
                    const selectedVariantId = this.value;
                    console.log("selectedVariantId: ",selectedVariantId)
                    updateVariantAttributes(selectedVariantId, variantAttributesData);
                });
            }
            
            // Update variant attributes based on selected variant
            function updateVariantAttributes(selectedVariantId, variantAttributesData) {
                const variantAttributeSelect = document.getElementById('productVariantAtt');
                
                // Clear current options
                variantAttributeSelect.innerHTML = '';
                
                if (!selectedVariantId) {
                    // No variant selected - disable and show placeholder
                    variantAttributeSelect.disabled = true;
                    variantAttributeSelect.innerHTML = '<option value="">Select Variant First</option>';
                    document.querySelector('#productVariantAtt').parentElement.querySelector('.form-text').textContent = 'Select a variant first to see available attributes';
                    return;
                }
                
                // Filter attributes for the selected variant
                const filteredAttributes = variantAttributesData.filter(attr => 
                    attr.variantName && attr.variantName._id === selectedVariantId
                );
                
                if (filteredAttributes.length === 0) {
                    // No attributes found for this variant
                    variantAttributeSelect.disabled = true;
                    variantAttributeSelect.innerHTML = '<option value="">No attributes available for this variant</option>';
                    document.querySelector('#productVariantAtt').parentElement.querySelector('.form-text').textContent = 'No attributes available for this variant';
                    return;
                }
                
                // Enable the select and add default option
                variantAttributeSelect.disabled = false;
                variantAttributeSelect.innerHTML = '<option value="">Select Attribute</option>';
                
                // Add filtered attributes
                filteredAttributes.forEach(attr => {
                    const option = document.createElement('option');
                    option.value = attr._id;
                    option.textContent = attr.name;
                    variantAttributeSelect.appendChild(option);
                });
                
                // Update help text
                document.querySelector('#productVariantAtt').parentElement.querySelector('.form-text').textContent = `Select an attribute for the selected variant (${filteredAttributes.length} available)`;
            }
            
            // Event listeners
            document.addEventListener('DOMContentLoaded', function() {
                // Auto-dismiss alerts
                const alerts = document.querySelectorAll('.alert.alert-dismissible');
                alerts.forEach(function(alert) {
                    setTimeout(function() {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }, 5000);
                });
            });
        </script>


<%- include('../partials/footer') %>

        <style>
            /* ComboTree Plugin Styling to match Bootstrap theme */
            .comboTreeWrapper {
                position: relative;
                width: 100%;
            }
            
            .comboTreeInputWrapper {
                position: relative;
                width: 100%;
            }
            
            .comboTreeInputBox {
                display: block;
                width: 100%;
                padding: 0.375rem 0.75rem;
                font-size: 1rem;
                font-weight: 400;
                line-height: 1.5;
                color: #212529;
                background-color: #fff;
                background-clip: padding-box;
                border: 1px solid #ced4da;
                appearance: none;
                border-radius: 0.375rem;
                transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            }
            
            .comboTreeInputBox:focus {
                color: #212529;
                background-color: #fff;
                border-color: #86b7fe;
                outline: 0;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            }
            
            .comboTreeArrowBtn {
                position: absolute;
                top: 50%;
                right: 0.75rem;
                transform: translateY(-50%);
                width: 16px;
                height: 16px;
                background: none;
                border: none;
                cursor: pointer;
                color: #6c757d;
                z-index: 3;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .comboTreeArrowBtnImg {
                font-size: 16px;
            }
            
            .comboTreeDropDownContainer {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #fff;
                border: 1px solid rgba(0, 0, 0, 0.15);
                border-radius: 0.375rem;
                max-height: 300px;
                overflow-y: auto;
                overflow-x: hidden;
                z-index: 1000;
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                display: none;
                margin-top: 0.125rem;
                scrollbar-width: thin;
                scrollbar-color: #ced4da #f8f9fa;
            }
            
            .comboTreeDropDownContainer::-webkit-scrollbar {
                width: 8px;
            }
            
            .comboTreeDropDownContainer::-webkit-scrollbar-track {
                background: #f8f9fa;
                border-radius: 4px;
                margin: 4px 0;
            }
            
            .comboTreeDropDownContainer::-webkit-scrollbar-thumb {
                background: #ced4da;
                border-radius: 4px;
                border: 1px solid #f8f9fa;
            }
            
            .comboTreeDropDownContainer::-webkit-scrollbar-thumb:hover {
                background: #adb5bd;
            }
            
            .comboTreeDropDownContainer::-webkit-scrollbar-thumb:active {
                background: #6c757d;
            }
            
            .comboTreeDropDownContent {
                padding: 0.5rem 0;
            }
            
            .comboTreeDropDownContainer ul {
                list-style: none;
                margin: 0;
                padding: 0;
            }
            
            .comboTreeDropDownContainer li {
                padding: 0;
                margin: 0;
            }
            
            .comboTreeItemTitle {
                display: block;
                padding: 0.25rem 1rem;
                clear: both;
                font-weight: 400;
                color: #212529;
                text-align: inherit;
                text-decoration: none;
                white-space: nowrap;
                background-color: transparent;
                border: 0;
                cursor: pointer;
                transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
                width: 100%;
            }
            
            .comboTreeItemTitle:hover,
            .comboTreeItemTitle:focus {
                color: #1e2125;
                background-color: #e9ecef;
            }
            
            .comboTreeItemTitle.comboTreeItemHover {
                color: #1e2125;
                background-color: #e9ecef;
            }
            
            .comboTreeParentPlus {
                display: inline-block;
                margin-right: 0.5rem;
                color: #6c757d;
                cursor: pointer;
                width: 16px;
                text-align: center;
            }
            
            .ComboTreeItemParent > .comboTreeItemTitle {
                font-weight: 500;
            }
            
            /* Bootstrap form styling consistency */
            .form-label {
                margin-bottom: 0.5rem;
                font-weight: 500;
                color: #212529;
            }
            
            .form-text {
                margin-top: 0.25rem;
                font-size: 0.875em;
                color: #6c757d;
            }
            
            /* Ensure dropdown appears above other elements */
            .comboTreeWrapper {
                z-index: 1050;
            }
            
            /* Variant form styling */
            #variantForm {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
            }
            
            #variantForm .card-header {
                background-color: #e9ecef;
                border-bottom: 1px solid #dee2e6;
            }
            
            .table-sm th, .table-sm td {
                padding: 0.5rem;
                font-size: 0.875rem;
                vertical-align: middle;
            }
            
            /* Responsive adjustments */
            @media (max-width: 768px) {
                #variantForm .row > div {
                    margin-bottom: 0.75rem;
                }
                
                #variantForm .col-md-2 {
                    flex: 0 0 100%;
                    max-width: 100%;
                }
                
                .table-responsive {
                    font-size: 0.8rem;
                }
            }
            
            /* Dark mode support */
            @media (prefers-color-scheme: dark) {
                .table th, .table td {
                    color: white;
                }
                
                #variantForm {
                    background-color: #2d3748;
                    border-color: #4a5568;
                }
                
                #variantForm .card-header {
                    background-color: #4a5568;
                    border-color: #4a5568;
                    color: white;
                }
            }
            
            .dark-mode .table th, 
            .dark-mode .table td,
            [data-theme="dark"] .table th,
            [data-theme="dark"] .table td,
            body.dark .table th,
            body.dark .table td {
                color: white;
            }
            
            .dark-mode #variantForm,
            [data-theme="dark"] #variantForm,
            body.dark #variantForm {
                background-color: #2d3748;
                border-color: #4a5568;
            }
            
            .dark-mode #variantForm .card-header,
            [data-theme="dark"] #variantForm .card-header,
            body.dark #variantForm .card-header {
                background-color: #4a5568;
                border-color: #4a5568;
                color: white;
            }
        </style>

        <!-- Include comboTree CSS -->
        <link rel="stylesheet" href="/combotree/combotreestyle.css">
        
        <!-- Include comboTree JS -->
        <script src="/combotree/comboTreePlugin.js"></script>

        <script>
            $(document).ready(function() {
                // Category tree data from backend
                var categoryTreeData = <%- JSON.stringify(categoryTree) %>
                
                // Add a "Root Category" option at the beginning
                var comboTreeData = [
                    {
                        id: '',
                        title: 'Root Category',
                        isSelectable: true
                    }
                ];
                
                // Add the actual category tree data
                if (categoryTreeData && categoryTreeData.length > 0) {
                    comboTreeData = comboTreeData.concat(categoryTreeData);
                }
                
                // Initialize comboTree
                var comboTree = $('#categoryParentTree').comboTree({
                    source: comboTreeData,
                    isMultiple: false,
                    collapse: false,
                    selectableLastNode: true
                });
                
                // Handle selection change
                comboTree.onChange(function() {
                    var selectedIds = comboTree.getSelectedIds();
                    var selectedId = selectedIds && selectedIds.length > 0 ? selectedIds[0] : '';
                    $('#categoryParent').val(selectedId);
                });
            });
        </script>

    </body>
</html>
